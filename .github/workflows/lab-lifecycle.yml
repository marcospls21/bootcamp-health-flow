name: üß™ Lab Lifecycle (Sec > Build > Deploy > Wait > Destroy)

on:
  workflow_dispatch:
    inputs:
      duration_minutes:
        description: 'Tempo de vida do Lab (minutos):'
        required: true
        default: '60'
        type: choice
        options:
        - '30'
        - '60'
        - '120'
        - '180'

env:
  # Credenciais AWS
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
  AWS_REGION: us-east-1
  
  # Configura√ß√£o Docker (Ajuste se usar ECR)
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/health-core:latest

jobs:
  # --- 1. SEGURAN√áA (SAST) ---
  security-check:
    name: üõ°Ô∏è Security Check (Trivy)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Run Trivy FS Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          hide-progress: false
          format: 'table'
          severity: 'CRITICAL,HIGH'

      # Descomente se tiver SonarCloud configurado
      # - name: SonarCloud Scan
      #   uses: SonarSource/sonarcloud-github-action@master
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # --- 2. BUILD E PUSH DA IMAGEM ---
  build-push:
    name: üê≥ Build & Push Docker
    needs: security-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: ./src/core-app
          push: true
          tags: ${{ env.IMAGE_NAME }}

      - name: Run Trivy Image Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true

  # --- 3. INFRAESTRUTURA (LIFECYCLE) ---
  lab-session:
    name: üß™ Lab Session (${{ github.event.inputs.duration_minutes }}m)
    needs: build-push
    runs-on: ubuntu-latest
    timeout-minutes: 180 
    
    # Passa as vari√°veis para o Terraform
    env:
      TF_VAR_datadog_api_key: ${{ secrets.TF_VAR_datadog_api_key }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      # Inicializa SEM S3 (Backend Local)
      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init -upgrade

      - name: üöÄ Terraform Apply
        id: apply
        working-directory: ./terraform
        run: terraform apply -auto-approve

      - name: ‚ÑπÔ∏è Mostrar Acessos
        if: steps.apply.outcome == 'success'
        working-directory: ./terraform
        run: |
          echo "‚úÖ LAB PRONTO!"
          echo "---------------------------------------------------"
          echo "Para configurar seu kubectl local:"
          terraform output configure_kubectl
          echo "---------------------------------------------------"
          echo "Senha do ArgoCD:"
          terraform output argocd_password_command
          echo "---------------------------------------------------"

      # O MODO DE ESPERA (O Lab fica "vivo" aqui)
      - name: ‚è≥ Aguardando Uso do Lab
        if: steps.apply.outcome == 'success'
        run: |
          echo "O ambiente ficar√° ativo por ${{ github.event.inputs.duration_minutes }} minutos."
          echo "Se terminar antes, clique em 'Cancel Workflow' para destruir tudo imediatamente."
          sleep $((${{ github.event.inputs.duration_minutes }} * 60))

      # --- FASE DE DESTRUI√á√ÉO (Roda Sempre) ---
      - name: üß® Terraform Destroy (Auto-Cleanup)
        if: always() # Garante que rode mesmo se cancelar ou der erro no wait
        working-directory: ./terraform
        run: |
          echo "Iniciando destrui√ß√£o autom√°tica..."
          terraform destroy -auto-approve